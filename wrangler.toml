name = "media-orchestrator"
main = "cloudflare/media-orchestrator/index.ts"
tsconfig = "cloudflare/media-orchestrator/tsconfig.json"
compatibility_date = "2025-10-19"
workers_dev = true

[dev]
port = 8787
local_protocol = "http"

## Durable Object migrations (inherited by envs)
[[migrations]]
tag = "v1-render-job-do"
new_classes = ["RenderJobDO"]

[[migrations]]
tag = "v2-containers"
new_sqlite_classes = [
  "MediaDownloaderContainer",
  "BurnerFfmpegContainer",
  "RendererRemotionContainer",
]

## Local development environment
[env.local]
name = "media-orchestrator-local"

[env.local.vars]
PREFER_EXTERNAL_CONTAINERS = "true"
CONTAINER_BASE_URL = "http://localhost:9080"
CONTAINER_BASE_URL_REMOTION = "http://localhost:8190"
CONTAINER_BASE_URL_DOWNLOADER = "http://localhost:8100"
NEXT_BASE_URL = "http://localhost:3000"
JOB_CALLBACK_HMAC_SECRET = "replace-with-strong-secret"
# 预签名 PUT 有效期（秒）：开发 600，生产可提升（如 1800）
PUT_EXPIRES = 600
# S3-compatible storage direct to Cloudflare R2
# Provide S3_ACCESS_KEY_ID/S3_SECRET_ACCESS_KEY via `wrangler secret put ...`
S3_ENDPOINT = "https://f191bfcfdbc84185ae742e69847082e0.r2.cloudflarestorage.com"
S3_INTERNAL_ENDPOINT = "https://f191bfcfdbc84185ae742e69847082e0.r2.cloudflarestorage.com"
S3_BUCKET_NAME = "vidgen-render"
S3_STYLE = "vhost"
S3_REGION = "us-east-1"
# 容器向 Worker 回调时使用的地址（本地 Docker）
ORCHESTRATOR_BASE_URL_CONTAINER = "http://host.docker.internal:8787"

[[env.local.kv_namespaces]]
binding = "JOBS"
id = "local-jobs-namespace"
preview_id = "local-jobs-namespace"

[[env.local.r2_buckets]]
binding = "RENDER_BUCKET"
bucket_name = "vidgen-render"
preview_bucket_name = "vidgen-render-dev"

[[env.local.durable_objects.bindings]]
name = "RENDER_JOB_DO"
class_name = "RenderJobDO"

[[env.local.containers]]
class_name = "MediaDownloaderContainer"
image = "containers/media-downloader/Dockerfile"
image_build_context = "."
max_instances = 10

[[env.local.containers]]
class_name = "BurnerFfmpegContainer"
image = "containers/burner-ffmpeg/Dockerfile"
image_build_context = "."
max_instances = 10

[[env.local.containers]]
class_name = "RendererRemotionContainer"
image = "containers/renderer-remotion/Dockerfile"
image_build_context = "."
max_instances = 5

[[env.local.durable_objects.bindings]]
name = "MEDIA_DOWNLOADER"
class_name = "MediaDownloaderContainer"

[[env.local.durable_objects.bindings]]
name = "BURNER_FFMPEG"
class_name = "BurnerFfmpegContainer"

[[env.local.durable_objects.bindings]]
name = "RENDERER_REMOTION"
class_name = "RendererRemotionContainer"

# Lightweight local env without Cloudflare Containers (uses external Docker services and skips remote container builds)
[env.local-lite]
name = "media-orchestrator-local-lite"

[env.local-lite.vars]
PREFER_EXTERNAL_CONTAINERS = "true"
NO_CF_CONTAINERS = "true"
CONTAINER_BASE_URL = "http://localhost:9080"
CONTAINER_BASE_URL_REMOTION = "http://localhost:8190"
CONTAINER_BASE_URL_DOWNLOADER = "http://localhost:8100"
NEXT_BASE_URL = "http://localhost:3000"
JOB_CALLBACK_HMAC_SECRET = "replace-with-strong-secret"
PUT_EXPIRES = 600
S3_ENDPOINT = "https://f191bfcfdbc84185ae742e69847082e0.r2.cloudflarestorage.com"
S3_INTERNAL_ENDPOINT = "https://f191bfcfdbc84185ae742e69847082e0.r2.cloudflarestorage.com"
S3_BUCKET_NAME = "vidgen-render"
S3_STYLE = "vhost"
S3_REGION = "us-east-1"
ORCHESTRATOR_BASE_URL_CONTAINER = "http://host.docker.internal:8787"

[[env.local-lite.kv_namespaces]]
binding = "JOBS"
id = "e80f8eec95c9409e9997de179aafca3c"
preview_id = "e80f8eec95c9409e9997de179aafca3c"

[[env.local-lite.r2_buckets]]
binding = "RENDER_BUCKET"
bucket_name = "vidgen-render"
preview_bucket_name = "vidgen-render-dev"

[[env.local-lite.durable_objects.bindings]]
name = "RENDER_JOB_DO"
class_name = "RenderJobDO"

## Production environment bindings (replace with real IDs before deploy)
[env.production]
name = "media-orchestrator"

[env.production.vars]
# 默认使用 Cloudflare Containers（如需外部容器平台，将此设为 "true" 并配置 CONTAINER_BASE_URL*）
PREFER_EXTERNAL_CONTAINERS = "true"
# Dockploy external containers (public base URLs)
CONTAINER_BASE_URL = "https://burner.temp-drop-files.store"
CONTAINER_BASE_URL_REMOTION = "https://remotion.temp-drop-files.store"
CONTAINER_BASE_URL_DOWNLOADER = "https://downloader.temp-drop-files.store"
# Worker 回调 Next：务必替换为你的生产域名
NEXT_BASE_URL = "https://<your-next-app-domain>"
# 建议通过 `wrangler secret put JOB_CALLBACK_HMAC_SECRET` 注入；此处仅占位
JOB_CALLBACK_HMAC_SECRET = "replace-with-strong-secret"
# 预签名 PUT 有效期（秒）
PUT_EXPIRES = 1800
# R2 直连（S3 兼容）
S3_ENDPOINT = "https://f191bfcfdbc84185ae742e69847082e0.r2.cloudflarestorage.com"
S3_INTERNAL_ENDPOINT = "https://f191bfcfdbc84185ae742e69847082e0.r2.cloudflarestorage.com"
S3_BUCKET_NAME = "vidgen-render"
S3_STYLE = "vhost"
S3_REGION = "us-east-1"

[[env.production.kv_namespaces]]
binding = "JOBS"
# TODO: replace with your real KV namespace ID
id = "REPLACE_WITH_PROD_JOBS_NAMESPACE_ID"

[[env.production.r2_buckets]]
binding = "RENDER_BUCKET"
bucket_name = "vidgen-render"

[[env.production.durable_objects.bindings]]
name = "RENDER_JOB_DO"
class_name = "RenderJobDO"

# Containers configuration (build and run media engines inside Cloudflare)
# Requires Workers Paid plan + Containers beta access.
[[env.production.containers]]
class_name = "MediaDownloaderContainer"
image = "containers/media-downloader/Dockerfile"
image_build_context = "."
max_instances = 10

[[env.production.containers]]
class_name = "BurnerFfmpegContainer"
image = "containers/burner-ffmpeg/Dockerfile"
image_build_context = "."
max_instances = 10

[[env.production.containers]]
class_name = "RendererRemotionContainer"
image = "containers/renderer-remotion/Dockerfile"
image_build_context = "."
max_instances = 5

[[env.production.durable_objects.bindings]]
name = "MEDIA_DOWNLOADER"
class_name = "MediaDownloaderContainer"

[[env.production.durable_objects.bindings]]
name = "BURNER_FFMPEG"
class_name = "BurnerFfmpegContainer"

[[env.production.durable_objects.bindings]]
name = "RENDERER_REMOTION"
class_name = "RendererRemotionContainer"
